<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste API Promo√ß√µes</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .log { background: #000; color: #0f0; padding: 15px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .error { color: #ff0000; }
        .success { color: #00aa00; }
        .warning { color: #ff8800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste da API de Promo√ß√µes</h1>
        <p>Este teste vai verificar se a API est√° funcionando corretamente.</p>
        
        <button onclick="testarDebugTabela()">üîç Debug Tabela</button>
        <button onclick="testarAPI()">üöÄ Testar API Completa</button>
        <button onclick="limparLog()">üßπ Limpar Log</button>
        
        <div id="log" class="log">Clique em "Testar API" para come√ßar...</div>
    </div>

    <script>
        const logElement = document.getElementById('log');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0f0',
                error: '#f00', 
                success: '#0a0',
                warning: '#fa0'
            };
            
            const span = document.createElement('span');
            span.style.color = colors[type] || '#0f0';
            span.textContent = `[${timestamp}] ${message}\n`;
            logElement.appendChild(span);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function limparLog() {
            logElement.innerHTML = '';
        }
        
        async function testarAPI() {
            log('üîç INICIANDO TESTE DA API DE PROMO√á√ïES', 'info');
            log('=' .repeat(50), 'info');
            
            // PRIMEIRO: Testar debug da tabela
            await testarDebugTabela();
            
            log('', 'info');
            log('üîÑ AGORA TESTANDO API PRINCIPAL...', 'info');
            log('', 'info');
            
            // Dados de teste
            const testData = {
                selectedFields: ['Cliente', 'Whatsapp', 'Loja', 'Data_Envio'],
                startDate: '2024-01-01',
                endDate: '2024-12-31'
            };
            
            log('üì§ Dados enviados:', 'info');
            log(`   selectedFields: ${JSON.stringify(testData.selectedFields)}`, 'info');
            log(`   startDate: ${testData.startDate}`, 'info');
            log(`   endDate: ${testData.endDate}`, 'info');
            log('', 'info');
            
            try {
                log('üîÑ Fazendo requisi√ß√£o para /api/reports/promotions...', 'info');
                
                const response = await fetch('/api/reports/promotions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                log(`üì• Status da resposta: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üì• Status text: ${response.statusText}`, response.ok ? 'success' : 'error');
                
                // Verificar headers
                log('üìã Headers da resposta:', 'info');
                for (const [key, value] of response.headers.entries()) {
                    log(`   ${key}: ${value}`, 'info');
                }
                log('', 'info');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('‚ùå ERRO NA API:', 'error');
                    log(errorText, 'error');
                    return;
                }
                
                const result = await response.json();
                log('‚úÖ RESPOSTA RECEBIDA:', 'success');
                log(`   success: ${result.success}`, 'success');
                log(`   total: ${result.total}`, 'success');
                log(`   userEmpresa: ${result.userEmpresa}`, 'success');
                log(`   message: ${result.message}`, 'success');
                log(`   data length: ${result.data?.length || 0}`, 'success');
                
                if (result.userInfo) {
                    log('üë§ Informa√ß√µes do usu√°rio:', 'info');
                    log(`   email: ${result.userInfo.email}`, 'info');
                    log(`   nome: ${result.userInfo.nome}`, 'info');
                    log(`   empresa: ${result.userInfo.empresa}`, 'info');
                    log(`   rede: ${result.userInfo.rede}`, 'info');
                }
                
                log('', 'info');
                
                if (result.data && result.data.length > 0) {
                    log('üìä DADOS ENCONTRADOS:', 'success');
                    log(`   Total de registros: ${result.data.length}`, 'success');
                    log('   Primeiro registro:', 'success');
                    log(JSON.stringify(result.data[0], null, 2), 'success');
                } else {
                    log('üì≠ NENHUM DADO ENCONTRADO', 'warning');
                    log('', 'warning');
                    log('üîç POSS√çVEIS CAUSAS:', 'warning');
                    log('1. Empresa do usu√°rio n√£o confere com campo "Rede"', 'warning');
                    log('2. Filtros de data muito restritivos', 'warning');
                    log('3. Tabela realmente vazia para esta empresa', 'warning');
                    log('4. Problema de permiss√µes no Supabase', 'warning');
                    
                    if (result.userEmpresa) {
                        log('', 'warning');
                        log(`üí° DICA: Verifique se existe algum registro com Rede = "${result.userEmpresa}"`, 'warning');
                        log('   Query para testar no Supabase:', 'warning');
                        log(`   SELECT * FROM "Relatorio Envio de Promo√ß√µes" WHERE "Rede" = '${result.userEmpresa}' LIMIT 5;`, 'warning');
                    }
                }
                
            } catch (error) {
                log('üí• ERRO NO TESTE:', 'error');
                log(error.message, 'error');
                log('', 'error');
                log('üîç POSS√çVEIS CAUSAS:', 'error');
                log('1. Servidor n√£o est√° rodando', 'error');
                log('2. Problema de rede', 'error');
                log('3. Erro de CORS', 'error');
                log('4. Problema de autentica√ß√£o', 'error');
            }
            
            log('', 'info');
            log('üèÅ TESTE CONCLU√çDO', 'info');
        }
        
        async function testarDebugTabela() {
            log('üîç TESTANDO DEBUG DA TABELA...', 'info');
            
            try {
                const response = await fetch('/api/debug/promotions-table');
                
                if (!response.ok) {
                    log(`‚ùå Erro no debug: ${response.status}`, 'error');
                    return;
                }
                
                const result = await response.json();
                log('‚úÖ DEBUG DA TABELA CONCLU√çDO:', 'success');
                
                result.results.tests.forEach(test => {
                    const status = test.status === 'success' ? '‚úÖ' : '‚ùå';
                    log(`${status} ${test.test}:`, test.status === 'success' ? 'success' : 'error');
                    
                    if (test.status === 'success') {
                        if (test.count !== undefined) {
                            log(`   Registros: ${test.count}`, 'success');
                        }
                        if (test.uniqueValues) {
                            log(`   Valores √∫nicos: ${JSON.stringify(test.uniqueValues)}`, 'success');
                        }
                        if (test.sampleDates) {
                            log(`   Datas exemplo: ${JSON.stringify(test.sampleDates)}`, 'success');
                        }
                        if (test.columns) {
                            log(`   Colunas: ${JSON.stringify(test.columns)}`, 'success');
                        }
                    } else {
                        log(`   Erro: ${test.error}`, 'error');
                    }
                    log('', 'info');
                });
                
            } catch (error) {
                log(`üí• Erro no debug da tabela: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>